import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Components/AddressFieldInput/Implementation" />

# AddressFieldInput Implementation

Technical implementation guide for the AddressFieldInput component.

## Architecture

AddressFieldInput extends BaseInput with Web3-specific functionality:

```tsx
import { AddressFieldInput } from '@ledgerhq/ldls-ui-react';

// Basic usage
<AddressFieldInput
  placeholder="Enter address or ENS"
  value={address}
  onChange={(e) => setAddress(e.target.value)}
/>
```

## Key Features

### Customizable Prefix

The component displays "To:" as the default prefix label, but this can be customized via the `prefix` prop for different use cases.

```tsx
// Default "To:" prefix
<AddressFieldInput placeholder="Enter address or ENS" />

// Custom "From:" prefix for sender address input
<AddressFieldInput
  prefix={<span className="text-nowrap text-base group-has-[:disabled]:text-disabled">From:</span>}
  placeholder="Enter address or ENS"
/>

// Icon prefix
<AddressFieldInput
  prefix={<WalletIcon size={20} className="text-muted group-has-[:disabled]:text-disabled" />}
  placeholder="Enter address or ENS"
/>
```

### Context-Aware Suffix Icons

- **Empty state**: Shows IconButton QR code scanner for easy address scanning
- **With content**: Shows clear button for quick content removal

```tsx
// IconButton QR code scanner appears automatically when empty
<AddressFieldInput
  placeholder="Enter address or ENS"
  onQrCodeClick={() => openQrScanner()}
/>

// Clear button appears automatically when there's content
<AddressFieldInput defaultValue="0x742d35cc..." />
```

### Address Validation

Implement custom validation for different address formats:

```tsx
const [address, setAddress] = React.useState('');
const [error, setError] = React.useState('');

React.useEffect(() => {
  if (address.length > 0) {
    const isValidEthereumAddress = address.startsWith('0x') && address.length === 42;
    const isValidENS = address.endsWith('.eth');

    if (!isValidEthereumAddress && !isValidENS) {
      setError('Please enter a valid Ethereum address or ENS name');
    } else {
      setError('');
    }
  }
}, [address]);

<AddressFieldInput
  value={address}
  onChange={(e) => setAddress(e.target.value)}
  errorMessage={error}
  aria-invalid={!!error}
/>
```

### Custom Clear Behavior

Handle clearing logic with additional state management:

```tsx
<AddressFieldInput
  value={walletAddress}
  onChange={(e) => setWalletAddress(e.target.value)}
  onClear={() => {
    // BaseInput already handles clearing the input value
    setError(''); // Clear error state
    analytics.track('address_cleared');
  }}
/>
```

> **Note:** The clear button only clears the input value. Error states must be cleared separately in your `onClear` handler.

### Layout & Styling

The AddressFieldInput component takes the **full width** of its parent container by default. You can control the width using `containerClassName` (preferred) or wrapper containers:

```tsx
// ✅ Preferred: Direct width control
<AddressFieldInput placeholder="Enter address or ENS" containerClassName="max-w-md" />

// ✅ Responsive width control
<AddressFieldInput placeholder="Enter address or ENS" containerClassName="w-full md:max-w-md" />

// Alternative: Container wrapper
<div className="max-w-md">
  <AddressFieldInput placeholder="Enter address or ENS" />
</div>

// Full width in form (default behavior)
<form>
  <AddressFieldInput placeholder="Enter address or ENS" />
</form>
```

### Address Format Support

- **Ethereum addresses**: 42-character hexadecimal strings starting with '0x'
- **ENS names**: Human-readable names ending with '.eth'
- **Validation**: Implement real-time validation for better UX

### QR Code Integration

```tsx
const handleQrScan = () => {
  // Open QR scanner modal/camera
  openQrScanner()
    .then((scannedAddress) => {
      setAddress(scannedAddress);
      validateAddress(scannedAddress);
    })
    .catch((error) => {
      console.error('QR scan failed:', error);
    });
};

<AddressFieldInput
  placeholder="Enter address or ENS"
  value={address}
  onChange={(e) => setAddress(e.target.value)}
  onQrCodeClick={handleQrScan}
/>
```

## Common Patterns

### Transaction Forms

```tsx
<form>
  <AddressFieldInput
    placeholder="Enter address or ENS"
    value={recipientAddress}
    onChange={(e) => setRecipientAddress(e.target.value)}
    errorMessage={addressError}
    aria-invalid={!!addressError}
    containerClassName="max-w-md"
  />
  {/* Other transaction fields */}
</form>
```

### Address Book Integration

```tsx
<AddressFieldInput
  placeholder="Enter address or ENS"
  value={selectedAddress}
  onChange={(e) => setSelectedAddress(e.target.value)}
  onQrCodeClick={() => openQrScanner()}
  suffix={
    selectedAddress ? (
      <IconButton
        iconType="stroked"
        onClick={openAddressBook}
        aria-label="Open address book"
      >
        <ContactsIcon size={20} />
      </IconButton>
    ) : undefined
  }
/>
```

## Performance Considerations

- Debounce validation for real-time address checking
- Use React.memo for expensive validation computations
- Consider lazy loading for ENS resolution

## Testing

The component includes comprehensive test coverage for:

- **Prefix rendering**: Default "To:" label or custom prefix element
- **IconButton QR code**: Proper IconButton integration with accessibility
- **Icon switching**: QR code ↔ clear button based on content
- **Validation states**: Error messages and ARIA attributes
- **Interaction handling**: onChange, onClear, onQrCodeClick, focus states

## Best Practices

✅ **Do**

```tsx
// Use containerClassName for layout and width control (preferred)
<AddressFieldInput placeholder="Enter address or ENS" containerClassName="max-w-md" />

// Use containerClassName for responsive design
<AddressFieldInput placeholder="Enter address or ENS" containerClassName="w-full md:max-w-lg" />

// Use custom prefix for different contexts
<AddressFieldInput
  prefix={<span className="font-medium text-nowrap text-base">From:</span>}
  placeholder="Enter sender address"
/>

// Implement proper validation for address formats
const validateAddress = (address) => {
  const isEthereumAddress = address.startsWith('0x') && address.length === 42;
  const isENS = address.endsWith('.eth');
  return isEthereumAddress || isENS;
};
```

❌ **Don't**

```tsx
// Don't use generic wrapper divs when containerClassName is available
<div className="max-w-md">
  <AddressFieldInput placeholder="Enter address or ENS" />
</div>

// Don't disable QR code functionality without good reason
<AddressFieldInput onQrCodeClick={undefined} />

// Don't use complex elements as prefix without proper styling
<AddressFieldInput prefix={<ComplexComponent />} />
```
